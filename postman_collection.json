{
  "info": {
    "name": "Django Active Directory API",
    "description": "API endpoints for the Django-AD project.\n\nSetup:\n1. Start the server: python manage.py runserver\n2. Run the Login request first to get tokens\n3. The access token is auto-saved to the collection variable\n4. All other requests will use it automatically",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://127.0.0.1:8000",
      "type": "string"
    },
    {
      "key": "access_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "refresh_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Auth",
      "description": "Authentication endpoints",
      "item": [
        {
          "name": "Login (AD Credentials)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('access_token', jsonData.access);",
                  "    pm.collectionVariables.set('refresh_token', jsonData.refresh);",
                  "    pm.test('Login successful', function() {",
                  "        pm.expect(jsonData).to.have.property('access');",
                  "        pm.expect(jsonData).to.have.property('refresh');",
                  "        pm.expect(jsonData).to.have.property('user');",
                  "    });",
                  "    pm.test('Tokens saved to collection variables', function() {",
                  "        pm.expect(pm.collectionVariables.get('access_token')).to.not.be.empty;",
                  "    });",
                  "} else {",
                  "    pm.test('Login failed with status ' + pm.response.code, function() {",
                  "        pm.expect(pm.response.code).to.equal(200);",
                  "    });",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"sAMAccountName\": \"khaled\",\n    \"password\": \"your_ad_password_here\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login/",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login", ""]
            },
            "description": "Login with Active Directory credentials.\n\nFlow:\n1. Sends sAMAccountName + password to the server\n2. Server tries LDAP bind to AD with these credentials\n3. If AD says OK → looks up user in local DB\n4. Returns JWT access + refresh tokens\n\n**Replace the password with a real AD user password.**"
          },
          "response": [
            {
              "name": "Success (200)",
              "status": "OK",
              "code": 200,
              "body": "{\n    \"refresh\": \"eyJhbGciOiJIUzI1NiIsInR...\",\n    \"access\": \"eyJhbGciOiJIUzI1NiIsInR...\",\n    \"user\": {\n        \"id\": 1,\n        \"employee_id\": \"AD-khaled\",\n        \"sAMAccountName\": \"khaled\",\n        \"first_name_en\": \"Khaled\",\n        \"last_name_en\": \"Ahmed\",\n        \"job_title\": \"Developer\",\n        \"department\": \"IT\",\n        \"ad_data\": {\n            \"email\": \"khaled@ad.worex.com\",\n            \"phone\": \"+20123456789\",\n            \"display_name\": \"Khaled Ahmed\",\n            \"current_ou\": \"OU=IT,OU=New\"\n        }\n    }\n}"
            },
            {
              "name": "Invalid Credentials (401)",
              "status": "Unauthorized",
              "code": 401,
              "body": "{\n    \"error\": \"Invalid credentials\"\n}"
            },
            {
              "name": "Missing Fields (400)",
              "status": "Bad Request",
              "code": 400,
              "body": "{\n    \"error\": \"sAMAccountName and password required\"\n}"
            }
          ]
        },
        {
          "name": "Login (Admin - Local DB)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('access_token', jsonData.access);",
                  "    pm.collectionVariables.set('refresh_token', jsonData.refresh);",
                  "    pm.test('Admin login successful', function() {",
                  "        pm.expect(jsonData).to.have.property('access');",
                  "    });",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n    \"sAMAccountName\": \"admin\",\n    \"password\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/auth/login/",
              "host": ["{{base_url}}"],
              "path": ["api", "auth", "login", ""]
            },
            "description": "Login with the local superuser account.\n\nFlow:\n1. LDAPBackend tries AD auth → FAILS (admin is not in AD)\n2. ModelBackend tries local DB auth → SUCCEEDS\n3. Returns JWT tokens\n\n**Note:** This uses the superuser created by create_admin.py"
          }
        }
      ]
    },
    {
      "name": "Employee",
      "description": "Employee endpoints (require authentication)",
      "item": [
        {
          "name": "Get My Profile",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Profile retrieved successfully', function() {",
                  "    pm.expect(pm.response.code).to.equal(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('sAMAccountName');",
                  "    pm.expect(jsonData).to.have.property('ad_data');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/employee/profile/",
              "host": ["{{base_url}}"],
              "path": ["api", "employee", "profile", ""]
            },
            "description": "Get the currently logged-in user's profile.\n\nRequires: Bearer token from login.\n\nReturns DB data + live AD data (email, phone, OU, display name)."
          },
          "response": [
            {
              "name": "Success (200)",
              "status": "OK",
              "code": 200,
              "body": "{\n    \"id\": 1,\n    \"employee_id\": \"AD-khaled\",\n    \"sAMAccountName\": \"khaled\",\n    \"username\": \"khaled\",\n    \"first_name_en\": \"Khaled\",\n    \"last_name_en\": \"Ahmed\",\n    \"first_name_ar\": \"\",\n    \"last_name_ar\": \"\",\n    \"job_title\": \"Developer\",\n    \"department\": \"IT\",\n    \"ad_data\": {\n        \"email\": \"khaled@ad.worex.com\",\n        \"phone\": \"+20123456789\",\n        \"display_name\": \"Khaled Ahmed\",\n        \"current_ou\": \"OU=IT,OU=New\"\n    }\n}"
            },
            {
              "name": "Unauthorized (401)",
              "status": "Unauthorized",
              "code": 401,
              "body": "{\n    \"detail\": \"Authentication credentials were not provided.\"\n}"
            }
          ]
        },
        {
          "name": "List All Employees",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Employees list retrieved', function() {",
                  "    pm.expect(pm.response.code).to.equal(200);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/employees/",
              "host": ["{{base_url}}"],
              "path": ["api", "employees", ""]
            },
            "description": "List all employees (non-superuser only).\n\nRequires: Bearer token from login."
          }
        },
        {
          "name": "Get Employee by ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Employee retrieved', function() {",
                  "    pm.expect(pm.response.code).to.equal(200);",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('sAMAccountName');",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/employees/1/",
              "host": ["{{base_url}}"],
              "path": ["api", "employees", "1", ""]
            },
            "description": "Get a single employee by their database ID.\n\nChange the ID in the URL to match an actual employee."
          }
        }
      ]
    },
    {
      "name": "Audit Logs",
      "description": "OU Transfer audit log endpoints",
      "item": [
        {
          "name": "List All Audit Logs",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Audit logs retrieved', function() {",
                  "    pm.expect(pm.response.code).to.equal(200);",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/audit-logs/",
              "host": ["{{base_url}}"],
              "path": ["api", "audit-logs", ""]
            },
            "description": "List all OU transfer audit logs, ordered by most recent first.\n\nRequires: Bearer token from login."
          }
        },
        {
          "name": "Get Audit Log by ID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/api/audit-logs/1/",
              "host": ["{{base_url}}"],
              "path": ["api", "audit-logs", "1", ""]
            },
            "description": "Get a single audit log entry by ID."
          }
        }
      ]
    }
  ]
}
